import urllib
from urllib import parse

import requests,re,time,json

def getNews():
    try:
        api = "https://api.github.com/search/repositories?q=CVE-2022&sort=updated"
        req = requests.get(api).text
        cve_description=json.loads(req)['items'][0]['description']
        cve_url=json.loads(req)['items'][0]['html_url']
        return cve_url,cve_description
    except Exception as e:
        print (e,"github链接不通")

def send(SENDKEY,TITLE,CONTENT):
    API = 'http://un1kmsg.happysec.cn/index/processmsg/'
    headers = {
        "Content-Type": "application/x-www-form-urlencoded"
    }
    CONTENT = parse.quote(CONTENT)
    myobj = {'title': TITLE, 'content': CONTENT,'sendkey':SENDKEY}
    res = requests.post(API,data = myobj,headers=headers).text
    print(res)

def sendNews(dataold):
    try:
        while True:
            #监控时间间隔
            print("[*] 当前最新数据源:"+dataold+",等待结束后开始监控")
            time.sleep(10)
            #获取最新的cveurl
            datanew = getNews()[0]
            #推送标题
            text = r'有新的CVE送达'
            if dataold != datanew:
                dataold = datanew
                print('[+] 出现新CVE了')
                send('your key',text, getNews()[0]+"["+getNews()[1]+"]")
            else:
                print('[-] 无最新内容')
                pass


    except Exception as e:
        raise e


if __name__ == '__main__':
    dataold=getNews()[0]
    sendNews(dataold)
